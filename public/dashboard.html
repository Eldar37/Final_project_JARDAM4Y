<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>JARDAM4Y ‚Äî –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    .dashboard-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .message { padding: 12px 16px; margin-bottom: 20px; border-radius: var(--radius); font-weight: 600; font-size: 14px; display: none; }
    .message.show { display: block; animation: fadeInDown 0.3s ease; }
    .message.success { background: #d1fae5; color: #065f46; }
    .message.error { background: #fee2e2; color: #991b1b; }
    .form-toggle { margin-bottom: 24px; }
    .applications-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
    .app-card { background: var(--card); padding: 20px; border-radius: var(--radius); box-shadow: 0 4px 12px var(--shadow); border-left: 4px solid var(--primary); }
    .app-card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px var(--shadow); }
    .app-card h4 { margin: 0 0 8px 0; color: var(--primary); font-size: 16px; }
    .app-card p { margin: 6px 0; font-size: 13px; color: var(--muted); }
    .app-card .description { color: var(--text); font-size: 14px; margin: 12px 0; }
    .app-card .price { font-weight: 600; color: var(--accent); margin: 12px 0; }
    .app-buttons { display: flex; gap: 8px; margin-top: 12px; }
    .app-buttons .btn { flex: 1; padding: 8px 12px; font-size: 12px; }
    .btn-delete { background: #ef4444; color: white; }
    .btn-delete:hover { background: #dc2626; }
    .form-section { display: none; }
    .form-section.show { display: block; }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
    .loading { text-align: center; padding: 40px; }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="header-container">
      <div class="header-brand">
        <img src="/logo.png" alt="JARDAM4Y" class="header-logo">
        <p class="header-tagline">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</p>
      </div>
      <button onclick="location.href='/'" class="btn secondary" style="margin-left:auto;">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
    </div>
  </header>

  <main class="dashboard-container">
    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ/–æ—à–∏–±–∫–µ -->
    <div id="message" class="message"></div>

    <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è -->
    <div class="form-toggle">
      <button id="toggleFormBtn" class="btn primary">+ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É</button>
    </div>

    <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="formSection" class="form-section">
      <div class="card">
        <h3 id="formTitle">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É</h3>
        <form id="applicationForm">
          <div class="form-group">
            <label>–ò–º—è *</label>
            <input type="text" name="name" required placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è">
          </div>

          <div class="form-group">
            <label>–ö–æ–Ω—Ç–∞–∫—Ç (—Ç–µ–ª–µ—Ñ–æ–Ω/WhatsApp) *</label>
            <input type="text" name="contact" required placeholder="+966 552345346">
          </div>

          <div class="form-group">
            <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
            <select name="category" required>
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
              <option value="–ù—è–Ω—è (–¥–ª—è –¥–µ—Ç–µ–π)">–ù—è–Ω—è (–¥–ª—è –¥–µ—Ç–µ–π)</option>
              <option value="–ù—è–Ω—è (–ø–æ–∂–∏–ª—ã–µ)">–ù—è–Ω—è (–ø–æ–∂–∏–ª—ã–µ)</option>
              <option value="–ë—ã—Ç–æ–≤—ã–µ —É—Å–ª—É–≥–∏">–ë—ã—Ç–æ–≤—ã–µ —É—Å–ª—É–≥–∏</option>
              <option value="–£—Ö–æ–¥ –∑–∞ –∂–∏–≤–æ—Ç–Ω—ã–º–∏">–£—Ö–æ–¥ –∑–∞ –∂–∏–≤–æ—Ç–Ω—ã–º–∏</option>
              <option value="–î—Ä—É–≥–∏–µ —É—Å–ª—É–≥–∏">–î—Ä—É–≥–∏–µ —É—Å–ª—É–≥–∏</option>
            </select>
          </div>

          <div class="form-group">
            <label>–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</label>
            <textarea name="description" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è..."></textarea>
          </div>

          <div class="form-group">
            <label>–î–∞—Ç–∞/–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
            <input type="datetime-local" name="datetime">
          </div>

          <div class="form-group">
            <label>–¶–µ–Ω–∞</label>
            <input type="text" name="price" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 500 —Ä—É–±.">
          </div>

          <div class="actions">
            <button type="submit" class="btn primary">‚úì –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
            <button type="button" class="btn muted" onclick="resetForm()">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </form>
      </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫ -->
    <div>
      <h2 style="margin-bottom: 20px; color: var(--primary);">üìã –í–∞—à–∏ –∑–∞—è–≤–∫–∏ (<span id="appCount">0</span>)</h2>
      <div id="loadingState" class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>
      <div id="emptyState" class="empty-state" style="display: none;">üì≠ –£ –≤–∞—Å –Ω–µ—Ç –∑–∞—è–≤–æ–∫. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!</div>
      <div id="applicationsList" class="applications-grid"></div>
    </div>
  </main>

  <footer class="site-footer">¬© JARDAM4Y ‚Äî MVP</footer>

  <script>
    const token = localStorage.getItem('token');
    if (!token) { window.location.href = '/auth.html'; return; }
    let applications = [];
    let editingId = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', () => {
      loadApplications();
      document.getElementById('toggleFormBtn').addEventListener('click', toggleForm);
      document.getElementById('applicationForm').addEventListener('submit', handleSubmit);
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫
    async function loadApplications() {
      try {
        const res = await fetch('/api/applications/my', { headers: { 'x-session-token': token } });
        if (res.status === 401) {
          window.location.href = '/auth.html';
          return;
        }
        applications = await res.json() || [];
        renderApplications();
        document.getElementById('loadingState').style.display = 'none';
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', err);
        showMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞—è–≤–æ–∫', 'error');
        document.getElementById('loadingState').style.display = 'none';
      }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫
    function renderApplications() {
      const list = document.getElementById('applicationsList');
      const count = document.getElementById('appCount');
      count.textContent = applications.length;

      if (applications.length === 0) {
        list.innerHTML = '';
        document.getElementById('emptyState').style.display = 'block';
        return;
      }

      document.getElementById('emptyState').style.display = 'none';
      list.innerHTML = applications.map(app => `
        <div class="app-card">
          <h4>${app.name}</h4>
          <p>üìû ${app.contact}</p>
          <p>üè∑Ô∏è ${app.category}</p>
          ${app.description ? `<p class="description">üìù ${app.description}</p>` : ''}
          ${app.datetime ? `<p>üìÖ ${new Date(app.datetime).toLocaleDateString('ru-RU')}</p>` : ''}
          ${app.price ? `<p class="price">üí∞ ${app.price}</p>` : ''}
          <div class="app-buttons">
            <button class="btn primary" onclick="editApplication(${app.id})">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="btn btn-delete" onclick="deleteApplication(${app.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
      `).join('');
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã
    function toggleForm() {
      const form = document.getElementById('formSection');
      const btn = document.getElementById('toggleFormBtn');
      form.classList.toggle('show');
      btn.textContent = form.classList.contains('show') ? '‚úï –ó–∞–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É' : '+ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É';
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã (CREATE)
    async function handleSubmit(e) {
      e.preventDefault();
      const formData = new FormData(document.getElementById('applicationForm'));
      const data = Object.fromEntries(formData);

      if (editingId) {
        await updateApplication(editingId, data);
      } else {
        await createApplication(data);
      }
    }

    // CREATE
    async function createApplication(data) {
      try {
        const res = await fetch('/api/applications', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-session-token': token },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
          resetForm();
          loadApplications();
          showMessage('‚úÖ –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
        } else {
          showMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏', 'error');
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞:', err);
        showMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏', 'error');
      }
    }

    // UPDATE
    async function updateApplication(id, data) {
      try {
        const res = await fetch(`/api/applications/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
          resetForm();
          loadApplications();
          showMessage('‚úÖ –ó–∞—è–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
        } else {
          showMessage(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`, 'error');
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞:', err);
        showMessage(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: ${err.message}`, 'error');
      }
    }

    // DELETE
    async function deleteApplication(id) {
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?')) return;

      try {
        console.log('Attempting to delete application:', id);
        const res = await fetch(`/api/applications/${id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });
        
        console.log('Response status:', res.status);
        const text = await res.text();
        console.log('Response text:', text);
        
        let result;
        try {
          result = JSON.parse(text);
        } catch (e) {
          console.error('Failed to parse JSON:', text.substring(0, 100));
          showMessage(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: –ø–æ–ª—É—á–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π –æ—Ç–≤–µ—Ç`, 'error');
          return;
        }
        
        if (res.ok && result.success) {
          loadApplications();
          showMessage('‚úÖ –ó–∞—è–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
        } else {
          showMessage(`‚ùå –û—à–∏–±–∫–∞: ${result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å'}`, 'error');
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:', err);
        showMessage(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${err.message}`, 'error');
      }
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    function editApplication(id) {
      const app = applications.find(a => a.id === id);
      if (!app) return;

      editingId = id;
      const form = document.getElementById('applicationForm');
      form.name.value = app.name;
      form.contact.value = app.contact;
      form.category.value = app.category;
      form.description.value = app.description || '';
      form.datetime.value = app.datetime || '';
      form.price.value = app.price || '';

      document.getElementById('formTitle').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞—è–≤–∫—É';
      document.querySelector('#applicationForm button[type="submit"]').textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
      document.getElementById('formSection').classList.add('show');
      document.getElementById('toggleFormBtn').textContent = '‚úï –ó–∞–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É';
    }

    // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
    function resetForm() {
      editingId = null;
      document.getElementById('applicationForm').reset();
      document.getElementById('formTitle').textContent = '‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É';
      document.querySelector('#applicationForm button[type="submit"]').textContent = '‚úì –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É';
      document.getElementById('formSection').classList.remove('show');
      document.getElementById('toggleFormBtn').textContent = '+ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É';
    }

    // –°–æ–æ–±—â–µ–Ω–∏–µ
    function showMessage(text, type) {
      const msg = document.getElementById('message');
      msg.textContent = text;
      msg.className = `message show ${type}`;
      setTimeout(() => msg.classList.remove('show'), 3000);
    }
  </script>
</body>
</html>
